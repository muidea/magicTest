# CAS 系统功能测试场景与用例

## 1. 测试概述

基于 `data_struct.md` 中定义的数据结构依赖关系，本文档提供完整的测试场景和测试用例，用于指导后续测试代码编写。

### 1.1 核心实体依赖关系
```
Role (基础) → Account (依赖 Role) → Endpoint (依赖 Account & Role)
Namespace 为独立管理实体，但在权限校验逻辑中常与 Scope 字段关联。
```

### 1.2 测试策略
- **单元测试**: 针对每个实体的 CRUD 操作
- **集成测试**: 验证实体间的依赖关系
- **边界测试**: 测试字段的边界值和约束条件
- **异常测试**: 测试错误处理和异常场景

---

## 2. Role (角色) 测试场景

### 2.1 数据结构
- **结构体**: `Role`
- **依赖项**: `bc.Privilege` 对象列表
- **关键字段**: `ID`, `Name`, `Description`, `Group`, `Privilege`, `Status`

### 2.2 功能测试场景

#### 场景 R1: 角色创建与验证
- **前置条件**: 无
- **测试步骤**:
  1. 创建包含完整权限列表的角色
  2. 验证返回的角色包含所有必要字段
  3. 验证字段值匹配
  4. 验证权限列表正确性
- **预期结果**: 角色创建成功，所有字段验证通过

#### 场景 R2: 角色状态管理
- **前置条件**: 已创建角色
- **测试步骤**:
  1. 创建状态为启用(2)的角色
  2. 更新角色状态为禁用(1)
  3. 查询角色验证状态变更
  4. 使用状态过滤查询
- **预期结果**: 状态变更正确，过滤功能正常

#### 场景 R3: 角色依赖关系测试
- **前置条件**: 无
- **测试步骤**:
  1. 创建包含 `bc.Privilege` Mock 数据的角色
  2. 验证权限对象的完整性
  3. 测试权限列表为空的情况
  4. 测试权限列表包含无效数据的情况
- **预期结果**: 正确处理权限依赖关系

### 2.3 测试用例

| 用例ID | 测试类型 | 描述 | 输入数据 | 预期结果 |
|--------|----------|------|----------|----------|
| R-TC-001 | 正常 | 创建基本角色 | `name: "Admin", status: 2` | 创建成功，返回完整角色信息 |
| R-TC-002 | 正常 | 创建带权限的角色 | `privilege: [{id:1, module:"magicCas"}]` | 权限列表正确保存 |
| R-TC-003 | 边界 | 创建名称超长角色 | `name: 256字符字符串` | 创建失败或截断处理 |
| R-TC-004 | 边界 | 创建空描述角色 | `description: ""` | 创建成功 |
| R-TC-005 | 异常 | 创建重复名称角色 | 使用已存在的角色名 | 创建失败，返回错误 |
| R-TC-006 | 异常 | 创建缺少必填字段角色 | `name: null` | 创建失败，验证错误 |
| R-TC-007 | 正常 | 更新角色信息 | `description: "新描述"` | 更新成功，字段变更 |
| R-TC-008 | 正常 | 更新角色状态 | `status: 1 (禁用)` | 状态变更成功 |
| R-TC-009 | 异常 | 更新不存在的角色 | `id: 999999` | 更新失败，返回错误 |
| R-TC-010 | 正常 | 查询角色 | 有效角色ID | 返回完整角色信息 |
| R-TC-011 | 异常 | 查询不存在的角色 | `id: 999999` | 返回空或错误 |
| R-TC-012 | 正常 | 过滤角色(按名称) | `name: "Admin"` | 返回匹配的角色列表 |
| R-TC-013 | 正常 | 过滤角色(按状态) | `status: 2` | 返回启用状态的角色 |
| R-TC-014 | 正常 | 删除角色 | 有效角色ID | 删除成功，返回被删除角色 |
| R-TC-015 | 异常 | 删除不存在的角色 | `id: 999999` | 删除失败，返回错误 |

---

## 3. Account (账户) 测试场景

### 3.1 数据结构
- **结构体**: `Account`
- **依赖项**: `RoleLite` 指针
- **关键字段**: `ID`, `Account`, `Password`, `Email`, `Description`, `Namespace`

### 3.2 功能测试场景

#### 场景 A1: 账户创建与角色关联
- **前置条件**: 存在有效的 Role
- **测试步骤**:
  1. 创建关联到现有 Role 的账户
  2. 验证账户信息完整性
  3. 验证角色关联正确性
  4. 测试密码加密逻辑
- **预期结果**: 账户创建成功，角色关联正确

#### 场景 A2: 账户命名空间隔离
- **前置条件**: 多个命名空间
- **测试步骤**:
  1. 在不同命名空间创建同名账户
  2. 验证命名空间隔离性
  3. 测试跨命名空间查询
- **预期结果**: 命名空间正确隔离账户

#### 场景 A3: 账户密码安全
- **前置条件**: 无
- **测试步骤**:
  1. 创建带密码的账户
  2. 验证密码存储安全性（加密）
  3. 测试密码验证逻辑
  4. 测试密码重置功能
- **预期结果**: 密码安全处理，验证功能正常

### 3.3 测试用例

| 用例ID | 测试类型 | 描述 | 输入数据 | 预期结果 |
|--------|----------|------|----------|----------|
| A-TC-001 | 正常 | 创建基本账户 | `account: "user1", email: "test@example.com"` | 创建成功 |
| A-TC-002 | 正常 | 创建带角色关联的账户 | `roleLite: {id: 1, name: "Admin"}` | 角色关联正确 |
| A-TC-003 | 边界 | 创建超长邮箱账户 | `email: 255字符邮箱` | 创建成功或适当处理 |
| A-TC-004 | 边界 | 创建特殊字符账户名 | `account: "user@123"` | 创建成功 |
| A-TC-005 | 异常 | 创建重复账户名 | 已存在的账户名 | 创建失败 |
| A-TC-006 | 异常 | 创建无效邮箱格式 | `email: "invalid-email"` | 创建失败 |
| A-TC-007 | 异常 | 关联不存在的角色 | `roleLite: {id: 999999}` | 创建失败 |
| A-TC-008 | 正常 | 更新账户信息 | `description: "新描述"` | 更新成功 |
| A-TC-009 | 正常 | 更新账户邮箱 | `email: "new@example.com"` | 邮箱更新成功 |
| A-TC-010 | 异常 | 更新为重复邮箱 | 已存在的邮箱 | 更新失败 |
| A-TC-011 | 正常 | 查询账户 | 有效账户ID | 返回完整账户信息 |
| A-TC-012 | 正常 | 过滤账户(按账户名) | `account: "user1"` | 返回匹配账户 |
| A-TC-013 | 正常 | 过滤账户(按邮箱) | `email: "test@example.com"` | 返回匹配账户 |
| A-TC-014 | 正常 | 过滤账户(按命名空间) | `namespace: "ns1"` | 返回指定命名空间的账户 |
| A-TC-015 | 正常 | 删除账户 | 有效账户ID | 删除成功 |

---

## 4. Endpoint (端点) 测试场景

### 4.1 数据结构
- **结构体**: `Endpoint`
- **核心依赖**: `AccountLite`, `RoleLite`
- **关键字段**: `ID`, `Endpoint`, `Description`, `Account`, `Role`, `Scope`, `Status`, `StartTime`, `ExpireTime`

### 4.2 功能测试场景

#### 场景 E1: 端点时效性验证
- **前置条件**: 当前时间戳
- **测试步骤**:
  1. 创建 `StartTime < 当前时间 < ExpireTime` 的有效端点
  2. 创建已过期的端点 (`ExpireTime < 当前时间`)
  3. 创建未开始的端点 (`StartTime > 当前时间`)
  4. 验证时间逻辑正确性
- **预期结果**: 时间逻辑正确处理，仅有效端点可访问

#### 场景 E2: 端点权限关联
- **前置条件**: 有效的 Account 和 Role
- **测试步骤**:
  1. 创建关联 Account 和 Role 的端点
  2. 验证关联对象完整性
  3. 测试更新关联对象
  4. 测试删除关联对象后的端点状态
- **预期结果**: 关联关系正确处理

#### 场景 E3: 端点作用域控制
- **前置条件**: 多个命名空间
- **测试步骤**:
  1. 创建全局作用域 (`"*"`) 端点
  2. 创建多命名空间作用域 (`"n1,n2"`) 端点
  3. 创建空作用域 (`""`) 端点
  4. 验证不同作用域的访问权限
- **预期结果**: 作用域逻辑正确实现

### 4.3 测试用例

| 用例ID | 测试类型 | 描述 | 输入数据 | 预期结果 |
|--------|----------|------|----------|----------|
| E-TC-001 | 正常 | 创建有效时间端点 | `startTime: 当前时间-1h, expireTime: 当前时间+24h` | 创建成功 |
| E-TC-002 | 正常 | 创建全局作用域端点 | `scope: "*"` | 创建成功 |
| E-TC-003 | 正常 | 创建多命名空间端点 | `scope: "n1,n2,n3"` | 创建成功 |
| E-TC-004 | 边界 | 创建时间边界端点 | `startTime = expireTime` | 创建失败或零时长处理 |
| E-TC-005 | 边界 | 创建超长端点路径 | `endpoint: 500字符路径` | 创建成功或适当处理 |
| E-TC-006 | 异常 | 创建时间逻辑错误端点 | `startTime > expireTime` | 创建失败 |
| E-TC-007 | 异常 | 创建关联无效账户的端点 | `account: {id: 999999}` | 创建失败 |
| E-TC-008 | 异常 | 创建关联无效角色的端点 | `role: {id: 999999}` | 创建失败 |
| E-TC-009 | 正常 | 更新端点时间 | `expireTime: 新时间戳` | 更新成功 |
| E-TC-010 | 正常 | 更新端点作用域 | `scope: "new1,new2"` | 更新成功 |
| E-TC-011 | 正常 | 更新端点状态 | `status: 1 (禁用)` | 状态变更成功 |
| E-TC-012 | 正常 | 查询端点 | 有效端点ID | 返回完整端点信息 |
| E-TC-013 | 正常 | 过滤端点(按路径) | `endpoint: "/api/v1/test"` | 返回匹配端点 |
| E-TC-014 | 正常 | 过滤端点(按状态) | `status: 2` | 返回启用状态的端点 |
| E-TC-015 | 正常 | 过滤端点(按时间范围) | `startTime > X, expireTime < Y` | 返回时间范围内的端点 |
| E-TC-016 | 正常 | 删除端点 | 有效端点ID | 删除成功 |

---

## 5. Namespace (命名空间) 测试场景

### 5.1 数据结构
- **结构体**: `Namespace`
- **关键字段**: `ID`, `Name`, `Description`, `Status`, `StartTime`, `ExpireTime`, `Scope`

### 5.2 功能测试场景

#### 场景 N1: 命名空间作用域逻辑
- **前置条件**: 无
- **测试步骤**:
  1. 创建全局作用域 (`"*"`) 命名空间
  2. 创建跨空间访问 (`"n1,n2"`) 命名空间
  3. 创建仅限自身 (`""`) 命名空间
  4. 验证不同作用域的权限隔离
- **预期结果**: 作用域逻辑正确实现

#### 场景 N2: 命名空间时间管理
- **前置条件**: 当前时间戳
- **测试步骤**:
  1. 创建有效时间范围的命名空间
  2. 创建已过期的命名空间
  3. 创建未开始的命名空间
  4. 验证时间相关的业务逻辑
- **预期结果**: 时间管理功能正常

#### 场景 N3: 命名空间层级关系
- **前置条件**: 父命名空间
- **测试步骤**:
  1. 在父命名空间下创建子命名空间
  2. 验证层级关系
  3. 测试权限继承
  4. 测试跨层级访问
- **预期结果**: 层级关系正确处理

### 5.3 测试用例

| 用例ID | 测试类型 | 描述 | 输入数据 | 预期结果 |
|--------|----------|------|----------|----------|
| N-TC-001 | 正常 | 创建基本命名空间 | `name: "ns1", scope: "*"` | 创建成功 |
| N-TC-002 | 正常 | 创建多作用域命名空间 | `scope: "ns1,ns2,ns3"` | 创建成功 |
| N-TC-003 | 正常 | 创建空作用域命名空间 | `scope: ""` | 创建成功 |
| N-TC-004 | 边界 | 创建超长名称命名空间 | `name: 256字符` | 创建成功或适当处理 |
| N-TC-005 | 边界 | 创建特殊字符作用域 | `scope: "a*b,c@d"` | 创建成功或验证处理 |
| N-TC-006 | 异常 | 创建重复名称命名空间 | 已存在的命名空间名 | 创建失败 |
| N-TC-007 | 异常 | 创建无效时间命名空间 | `startTime > expireTime` | 创建失败 |
| N-TC-008 | 正常 | 更新命名空间描述 | `description: "新描述"` | 更新成功 |
| N-TC-009 | 正常 | 更新命名空间作用域 | `scope: "new1,new2"` | 更新成功 |
| N-TC-010 | 正常 | 更新命名空间状态 | `status: 1 (禁用)` | 状态变更成功 |
| N-TC-011 | 正常 | 查询命名空间 | 有效命名空间ID | 返回完整信息 |
| N-TC-012 | 正常 | 过滤命名空间(按名称) | `name: "ns1"` | 返回匹配命名空间 |
| N-TC-013 | 正常 | 过滤命名空间(按状态) | `status: 2` | 返回启用状态的命名空间 |
| N-TC-014 | 正常 | 过滤命名空间(按作用域) | `scope: "*"` | 返回全局作用域命名空间 |
| N-TC-015 | 正常 | 删除命名空间 | 有效命名空间ID | 删除成功 |

---

## 6. 集成测试场景

### 6.1 场景 IT1: 完整依赖链测试
- **前置条件**: 无
- **测试步骤**:
  1. 创建 Role
  2. 创建关联该 Role 的 Account
  3. 创建关联该 Account 和 Role 的 Endpoint
  4. 验证整个依赖链的完整性
  5. 删除 Endpoint → Account → Role（反向删除）
- **预期结果**: 依赖链正确处理，删除顺序正确

### 6.2 场景 IT2: 跨实体过滤测试
- **前置条件**: 创建多个关联实体
- **测试步骤**:
  1. 创建多个 Role、Account、Endpoint
  2. 使用复杂过滤条件跨实体查询
  3. 验证过滤结果的正确性
  4. 测试分页和排序
- **预期结果**: 跨实体过滤功能正常

### 6.3 场景 IT3: 并发操作测试
- **前置条件**: 基础数据已创建
- **测试步骤**:
  1. 并发创建关联实体
  2. 并发更新同一实体
  3. 并发删除和查询
  4. 验证数据一致性和锁机制
- **预期结果**: 并发操作正确处理，数据一致

---
